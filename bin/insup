#!/usr/bin/env ruby

require 'trollop'

require_relative '../lib/insup/version'
require_relative '../lib/insup/console'

SUB_COMMANDS = %w(init status config commit list-locations list-files listen insales)

global_opts = Trollop::options do
  version "insup #{Insup::VERSION} (c) 2014 nuinuhin@gmail.com"
  banner <<-EOS
Usage:
       insup status
       insup commit [file1, [file2, [...]]]
       insup config
       insup list-files
       insup listen
       insup init
       insup list-locations
       insup insales list-themes
EOS
  stop_on SUB_COMMANDS
end

cmd = ARGV.shift

if cmd.nil?
  raise Trollop::HelpNeeded
end

if !SUB_COMMANDS.include? cmd
  Trollop::die "unknown subcommand #{cmd.inspect}"
end

Insup::Console.start

begin
  case cmd
  when 'status'
    Insup::Console.status
  when 'config'
    Insup::Console.print_config
  when 'list-locations'
    Insup::Console.list_locations
  when 'list-files'
    if ARGV.include?('--all')
      Insup::Console.list_files(mode: :all)
    elsif ARGV.include?('--ignored')
      Insup::Console.list_files(mode: :ignored)
    else
      Insup::Console.list_files
    end
  when 'commit'
    Insup::Console.commit ARGV.map{|f| Insup::TrackedFile.new(f,Insup::TrackedFile::MODIFIED)}
  when 'listen'
    Insup::Console.listen
  when 'init'
    Insup::Console.init(ARGV[0])
  when 'insales'
    cmd = ARGV.shift
    case cmd
    when 'list-themes'
      Insup::Console.insales_list_themes
    end
  end
# rescue => ex
#   puts ex.message
end
